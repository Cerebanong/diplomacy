name: Deploy to Dev

on:
  push:
    branches: [dev]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared
        run: npm run build:shared

      - name: Bundle backend with esbuild
        run: |
          npx esbuild packages/backend/src/index.ts \
            --bundle --platform=node --target=node20 \
            --outfile=packages/backend/dist/index.js \
            --format=esm \
            --external:express --external:cors --external:helmet \
            --external:zod --external:dotenv --external:uuid --external:openai \
            --resolve-extensions=.ts,.js

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push to ACR
        run: |
          az acr build --registry macroqualityacr \
            --image diplomacy-api-dev:${{ github.sha }} \
            --file Dockerfile .

      - name: Deploy to Container App
        run: |
          az containerapp update \
            -n diplomacy-api-dev \
            -g personal-apps-rg \
            --image macroqualityacr.azurecr.io/diplomacy-api-dev:${{ github.sha }}

      - name: Update environment variables
        run: |
          az containerapp update \
            -n diplomacy-api-dev \
            -g personal-apps-rg \
            --set-env-vars \
              "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" \
              "CORS_ORIGINS=https://devdiplomacy.kevinandpauline.com,https://polite-sky-0e01f781e.4.azurestaticapps.net" \
              "NODE_ENV=development"

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared
        run: npm run build:shared

      - name: Build frontend
        run: npm run build:frontend
        env:
          VITE_API_URL: https://diplomacy-api-dev.purplemushroom-6e6a3ac6.westus2.azurecontainerapps.io

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: packages/frontend/dist
          output_location: ""
          skip_app_build: true
